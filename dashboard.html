<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatFlow - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-[#c7d2d7] min-h-screen flex">

<!-- Sidebar for Contacts -->
<div class="w-2/5 max-w-xs bg-[#e5e6e4] shadow-lg flex flex-col">
  <div class="p-4 border-b border-[#dfd9c7] flex justify-between items-center">
    <h2 class="text-[#6c6b6b] font-bold text-xl">Contacts</h2>
    <button id="addContactBtn" class="bg-[#dfd9c7] hover:bg-[#c7c0ad] px-2 py-1 rounded">+</button>
  </div>
  <div id="contacts" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
</div>

<!-- Chat Panel -->
<div class="flex-1 flex flex-col">
  <div class="bg-[#e5e6e4] p-4 border-b border-[#dfd9c7]">
    <h2 id="chatWith" class="text-[#6c6b6b] font-bold text-lg">Select a contact</h2>
  </div>
  <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
  <div class="p-4 bg-[#dfd9c7] flex gap-2">
    <input id="chatInput" type="text" placeholder="Type a message..." 
           class="flex-1 px-4 py-2 rounded-lg border border-[#c7d2d7]" />
    <button id="sendBtn" class="bg-[#6c6b6b] text-white px-4 py-2 rounded-lg hover:bg-[#4a4a4a]">Send</button>
  </div>
</div>

<!-- Add Contact Popup -->
<div id="contactPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-[#dfd9c7] p-6 rounded-2xl w-80 shadow-lg animate-fadeIn text-center">
    <h2 class="text-[#6c6b6b] font-bold text-lg mb-2">Add Contact</h2>
    <input id="contactName" type="text" placeholder="Contact Email" 
           class="w-full px-4 py-2 mb-4 rounded-lg border border-[#c7d2d7]" />
    <button id="saveContactBtn" class="w-full bg-[#6c6b6b] text-white py-2 rounded-lg hover:bg-[#4a4a4a]">Save</button>
  </div>
</div>

<script>
tailwind.config = {
  theme: { extend: {
    keyframes: { fadeIn:{'0%':{opacity:0},'100%':{opacity:1}} },
    animation: { fadeIn:'fadeIn 0.3s ease-in-out' }
  } }
}

// ------------------ Socket.IO ------------------
const socket = io("https://chatflow-backend-574t.onrender.com");

// Get logged-in user
const currentUser = localStorage.getItem("email");
if(!currentUser) window.location.href = "login.html";

let selectedContact = null;

// ------------------ Contacts ------------------
const contactsDiv = document.getElementById("contacts");
const addContactBtn = document.getElementById("addContactBtn");
const contactPopup = document.getElementById("contactPopup");
const saveContactBtn = document.getElementById("saveContactBtn");
const contactNameInput = document.getElementById("contactName");

let contacts = JSON.parse(localStorage.getItem(`contacts_${currentUser}`)) || [];

function renderContacts() {
  contactsDiv.innerHTML = "";
  contacts.forEach(contact => {
    const div = document.createElement("div");
    div.textContent = contact;
    div.className = "p-2 bg-[#dfd9c7] rounded cursor-pointer hover:bg-[#c7c0ad]";
    div.onclick = () => selectContact(contact);
    contactsDiv.appendChild(div);
  });
}
renderContacts();

addContactBtn.onclick = () => contactPopup.classList.remove("hidden");
saveContactBtn.onclick = () => {
  const contact = contactNameInput.value.trim();
  if(contact && !contacts.includes(contact)){
    contacts.push(contact);
    localStorage.setItem(`contacts_${currentUser}`, JSON.stringify(contacts));
    renderContacts();
    contactNameInput.value = "";
    contactPopup.classList.add("hidden");
  }
};

// ------------------ Chat ------------------
const chatMessages = document.getElementById("chatMessages");
const chatWithTitle = document.getElementById("chatWith");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

let chats = JSON.parse(localStorage.getItem(`chats_${currentUser}`)) || {};

function selectContact(contact){
  selectedContact = contact;
  chatWithTitle.textContent = contact;
  renderChat();
}

function renderChat(){
  chatMessages.innerHTML = "";
  if(!selectedContact) return;
  const msgs = chats[selectedContact] || [];
  msgs.forEach(msg => {
    const div = document.createElement("div");
    div.textContent = `${msg.from}: ${msg.text}`;
    div.className = `p-2 rounded ${msg.from===currentUser?"bg-[#6c6b6b] text-white":"bg-[#e5e6e4] text-[#6c6b6b]"}`;
    chatMessages.appendChild(div);
  });
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
sendBtn.onclick = () => {
  if(!selectedContact || !chatInput.value.trim()) return;
  const message = chatInput.value.trim();

  // Save locally
  if(!chats[selectedContact]) chats[selectedContact] = [];
  chats[selectedContact].push({from: currentUser, text: message});
  localStorage.setItem(`chats_${currentUser}`, JSON.stringify(chats));
  renderChat();

  // Send via Socket.IO
  socket.emit("send_message", {from: currentUser, to: selectedContact, text: message});
  chatInput.value = "";
};

// Receive message
socket.on("receive_message", (data) => {
  if(data.to === currentUser){
    if(!chats[data.from]) chats[data.from] = [];
    chats[data.from].push({from: data.from, text: data.text});
    localStorage.setItem(`chats_${currentUser}`, JSON.stringify(chats));
    if(selectedContact===data.from) renderChat();
  }
});
</script>

</body>
</html>