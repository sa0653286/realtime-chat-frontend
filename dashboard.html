<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatFlow — Dashboard</title>

<!-- Embedded styling (modern, mobile friendly) -->
<style>
  :root{
    --bg:#c7d2d7; /* Light Blue/Gray-Blue */
    --panel:#e5e6e4; /* Very Light Gray/Off-White */
    --muted:#dfd9c7; /* Light Beige/Pale Tan */
    --dark:#6c6b6b; /* Dark Gray/Charcoal */
    --accent:#1f6feb;
    --width-sidebar:320px;
  }

  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg); color:var(--dark); -webkit-font-smoothing:antialiased; display:flex; align-items:stretch; min-height:100vh}

  /* layout */
  .app {
    display:flex;
    width:100%;
    max-width:1200px;
    margin:24px auto;
    flex:1;
    background:transparent;
    gap:18px;
    padding:0 12px;
    box-sizing:border-box;
  }

  /* sidebar */
  .sidebar {
    width:var(--width-sidebar);
    min-width:240px;
    background:var(--panel);
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .brand {
    padding:18px;
    border-bottom:1px solid rgba(0,0,0,0.04);
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand .logo {
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#6c6b6b,#4b5563);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
  }
  .brand h1{font-size:18px;margin:0;color:var(--dark);font-weight:700}
  .brand p{margin:0;font-size:12px;color:rgba(0,0,0,0.45)}

  .search {
    padding:10px 14px;
    border-bottom:1px solid rgba(0,0,0,0.04);
  }
  .search input{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06); outline:none; font-size:14px;
  }

  .contacts {
    flex:1; overflow:auto; padding:10px;
  }

  .contact {
    display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; cursor:pointer;
    transition:background .15s, transform .06s;
  }
  .contact:hover{background:rgba(0,0,0,0.03);transform:translateY(-1px)}
  .contact.active{background:var(--muted); font-weight:600}

  .avatar {
    width:44px;height:44px;border-radius:10px;background:var(--dark);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
  }
  .contact .meta {flex:1; min-width:0;}
  .contact .name {font-size:14px;color:var(--dark); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .contact .sub {font-size:12px;color:rgba(0,0,0,0.45); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .add-contact-btn {
    margin:10px;padding:10px;border-radius:10px;background:var(--dark);color:white;border:none;cursor:pointer;width:calc(100% - 20px); align-self:center;
  }

  .sidebar-footer {
    padding:14px;border-top:1px solid rgba(0,0,0,0.04); display:flex; align-items:center; gap:12px;
  }
  .user-mini {display:flex; gap:10px; align-items:center}
  .user-mini .name {font-weight:700;color:var(--dark)}
  .settings-btn {margin-left:auto;background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:8px;cursor:pointer}

  /* main panel */
  .main {
    flex:1; display:flex; flex-direction:column; border-radius:14px; background:var(--panel); box-shadow:0 6px 18px rgba(0,0,0,0.08); overflow:hidden;
  }

  .main-header {
    padding:16px 18px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(0,0,0,0.04);
  }
  .main-header .title {font-weight:700;color:var(--dark); font-size:18px;}
  .main-header .info {font-size:13px;color:rgba(0,0,0,0.45)}
  .main-body {flex:1;display:flex; overflow:hidden}

  /* left chat area (messages) */
  .conv {
    flex:1; display:flex; flex-direction:column; min-width:0;
  }
  .messages {
    padding:16px; flex:1; overflow:auto; display:flex; flex-direction:column; gap:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  }

  .msg {
    display:inline-block; padding:10px 14px; border-radius:12px; max-width:70%; line-height:1.35;
    font-size:14px;
  }
  .msg.me { align-self:flex-end; background:var(--dark); color:white; border-bottom-right-radius:4px;}
  .msg.them { align-self:flex-start; background:var(--muted); color:var(--dark); border-bottom-left-radius:4px;}

  .compose {
    padding:12px; display:flex; gap:10px; align-items:center; border-top:1px solid rgba(0,0,0,0.04);
  }

  .compose input[type="text"]{
    flex:1;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);outline:none;font-size:14px;
  }
  .compose button{ background:var(--dark); color:white; padding:10px 14px; border-radius:10px;border:none; cursor:pointer}

  /* right panel */
  .right-panel {
    width:320px; border-left:1px solid rgba(0,0,0,0.04); padding:12px; box-sizing:border-box; background:transparent;
  }
  .panel-section {background:rgba(0,0,0,0.02); padding:12px;border-radius:10px;margin-bottom:12px}
  .panel-section h3{margin:0 0 8px 0;color:var(--dark);font-weight:700;font-size:13px}

  /* small screens */
  @media (max-width:900px){
    .app{flex-direction:column; padding:12px}
    .sidebar{width:100%}
    .right-panel{width:100%}
  }

  /* popup, new message badge */
  .new-pop {position:fixed; right:16px; top:16px; background:var(--panel); padding:10px 12px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); display:none}
</style>
</head>
<body>

  <div class="app" role="application">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Contacts">
      <div>
        <div class="brand">
          <div class="logo">CF</div>
          <div>
            <h1>ChatFlow</h1>
            <p>Realtime messaging</p>
          </div>
        </div>

        <div class="search">
          <input id="searchInput" placeholder="Search contacts..." aria-label="Search contacts">
        </div>

        <div class="contacts" id="contactsList" role="list">
          <!-- contacts populated by JS -->
        </div>

        <div style="padding:10px; display:flex;justify-content:center;">
          <button class="add-contact-btn" id="btnAddContact">+ New Contact</button>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="user-mini">
          <div class="avatar" id="miniAvatar" style="width:44px;height:44px;border-radius:8px;background:var(--dark);color:white;display:flex;align-items:center;justify-content:center;font-weight:700">U</div>
          <div>
            <div class="name" id="miniName">You</div>
            <div style="font-size:12px;color:rgba(0,0,0,0.45)" id="miniEmail">you@example.com</div>
          </div>
        </div>
        <button class="settings-btn" id="openSettings">Settings</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <div class="main-header">
        <div>
          <div class="title" id="chatTitle">Welcome</div>
          <div class="info" id="chatSubtitle">Select a contact to start chatting</div>
        </div>
        <div style="margin-left:auto">
          <button id="btnProfile" style="background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:10px">Profile</button>
        </div>
      </div>

      <div class="main-body" >
        <!-- conversation -->
        <section class="conv" aria-live="polite">
          <div class="messages" id="messages" role="log">
            <!-- messages -->
            <div style="text-align:center;color:rgba(0,0,0,0.45);">No conversation selected</div>
          </div>

          <div class="compose">
            <input type="text" id="inputMessage" placeholder="Write a message..." aria-label="Write a message">
            <button id="sendBtn">Send</button>
          </div>
        </section>

        <!-- right panel -->
        <aside class="right-panel">
          <div class="panel-section">
            <h3>Contact Details</h3>
            <div id="contactDetails">Select a contact to see details</div>
          </div>

          <div class="panel-section">
            <h3>Account</h3>
            <div><strong id="profileName">Your Name</strong></div>
            <div style="font-size:13px;color:rgba(0,0,0,0.45)" id="profileEmail">you@example.com</div>
            <button style="margin-top:10px;background:var(--dark);color:white;padding:8px;border-radius:8px;border:none;cursor:pointer" id="editProfile">Edit Profile</button>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <div class="new-pop" id="newPop"></div>

  <!-- Modals (created dynamically) -->
  <div id="modals"></div>

<script>
/*
  Dashboard — integrated JS
  - tries to use backend endpoints when available
  - works even without /users or /messages endpoints by using localStorage
  - Socket.IO realtime integration (emit 'send_message', listen 'receive_message')
*/

const BACKEND = "https://chatflow-backend-574t.onrender.com";
let socket = null;

// get logged-in user info (login page must set localStorage 'token' and 'user')
let token = localStorage.getItem('token') || null;
let me = null;
try { me = JSON.parse(localStorage.getItem('user')); } catch(e){ me = null; }

// if not logged in, redirect to login page
if(!me || !me.email){
  // fallback: allow demo mode if you want (comment out redirect for demo)
  // location.href = 'login.html';
  me = { id: null, username: 'Guest', email: 'guest@local' };
}

// UI elements
const contactsListEl = document.getElementById('contactsList');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('inputMessage');
const sendBtn = document.getElementById('sendBtn');
const chatTitleEl = document.getElementById('chatTitle');
const chatSubtitleEl = document.getElementById('chatSubtitle');
const miniNameEl = document.getElementById('miniName');
const miniEmailEl = document.getElementById('miniEmail');
const miniAvatarEl = document.getElementById('miniAvatar');
const profileNameEl = document.getElementById('profileName');
const profileEmailEl = document.getElementById('profileEmail');
const newPop = document.getElementById('newPop');
const searchInput = document.getElementById('searchInput');

miniNameEl.textContent = me.username || 'You';
miniEmailEl.textContent = me.email || '';
profileNameEl.textContent = me.username || 'You';
profileEmailEl.textContent = me.email || '';
miniAvatarEl.textContent = (me.username && me.username[0]) ? me.username[0].toUpperCase() : 'U';

let contacts = [];         // array of { name, email, id? }
let activeContact = null;  // currently selected contact (object)
let chats = {};            // local cache: chats['emailA|emailB'] = [{from, to, text, ts}, ...]

// helpers
const uid = (a,b) => {
  const x = (a||me.email), y = (b||'');
  return [x,y].sort().join('|');
};

function saveChatsToStorage(){ localStorage.setItem('chatflow_chats_'+(me.email||'guest'), JSON.stringify(chats)); }
function loadChatsFromStorage(){ try{ chats = JSON.parse(localStorage.getItem('chatflow_chats_'+(me.email||'guest')))||{} }catch(e){ chats = {}; } }

// load chats from storage now
loadChatsFromStorage();

// show popup toast
function showToast(text, timeout=2000){
  newPop.textContent = text;
  newPop.style.display = 'block';
  setTimeout(()=>{ newPop.style.display = 'none'; }, timeout);
}

// render contacts in sidebar
function renderContacts(filter=''){
  contactsListEl.innerHTML = '';
  const list = (filter? contacts.filter(c => (c.name || c.email).toLowerCase().includes(filter.toLowerCase())) : contacts);
  if(list.length === 0){
    contactsListEl.innerHTML = '<div style="padding:12px;color:rgba(0,0,0,0.45)">No contacts</div>';
    return;
  }
  list.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'contact';
    el.tabIndex = 0;
    el.innerHTML = `
      <div class="avatar" style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#6c6b6b,#4b5563);color:white;font-weight:700">${(c.name && c.name[0])?c.name[0].toUpperCase():'?'}</div>
      <div class="meta">
        <div class="name">${c.name || c.email}</div>
        <div class="sub">${c.email}</div>
      </div>
    `;
    el.addEventListener('click', ()=> selectContact(c));
    // active class
    if(activeContact && (activeContact.email === c.email)) el.classList.add('active');
    contactsListEl.appendChild(el);
  });
}

// select contact to chat
function selectContact(c){
  activeContact = c;
  chatTitleEl.textContent = c.name || c.email;
  chatSubtitleEl.textContent = c.email;
  // mark active visually
  document.querySelectorAll('.contact').forEach(n=>n.classList.remove('active'));
  // find element and add active
  const nodes = Array.from(document.querySelectorAll('.contact'));
  for(const n of nodes){
    if(n.querySelector('.sub') && n.querySelector('.sub').textContent === c.email) { n.classList.add('active'); break; }
  }
  renderMessagesForActive();
  showContactDetails(c);
}

// render messages for active contact
function renderMessagesForActive(){
  messagesEl.innerHTML = '';
  if(!activeContact) {
    messagesEl.innerHTML = '<div style="text-align:center;color:rgba(0,0,0,0.45);padding:24px">Select a contact to start chatting</div>';
    return;
  }
  const key = uid(me.email, activeContact.email);
  const list = chats[key] || [];
  if(list.length === 0){
    messagesEl.innerHTML = '<div style="text-align:center;color:rgba(0,0,0,0.45);padding:24px">No messages yet — start the conversation</div>';
    return;
  }
  list.forEach(msg=>{
    const d = document.createElement('div');
    d.className = 'msg ' + (msg.from === me.email ? 'me' : 'them');
    d.textContent = msg.text;
    messagesEl.appendChild(d);
  });
  // scroll to bottom
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// show contact details in right panel
function showContactDetails(c){
  const el = document.getElementById('contactDetails');
  if(!c){ el.innerHTML = 'Select a contact'; return; }
  el.innerHTML = `<div><strong>${c.name || c.email}</strong></div><div style="font-size:13px;color:rgba(0,0,0,0.45)">${c.email}</div>`;
}

// add new contact (popup)
function openAddContactModal(){
  const name = prompt('Contact name (optional)');
  const email = prompt('Contact email (required)');
  if(!email) return alert('Email required');
  const contact = { name: name || email.split('@')[0], email: email.trim() };
  if(contacts.find(x=>x.email === contact.email)) { showToast('Contact already exists'); return; }
  contacts.unshift(contact);
  renderContacts();
  // optionally persist contacts per user
  localStorage.setItem('chatflow_contacts_'+(me.email||'guest'), JSON.stringify(contacts));
  showToast('Contact added');
}

// load contacts: try backend /users then fallback to local storage or demo
async function loadContacts(){
  // try local persistence first
  const fromStorage = localStorage.getItem('chatflow_contacts_'+(me.email||'guest'));
  if(fromStorage){
    try{ contacts = JSON.parse(fromStorage); renderContacts(); } catch(e){ contacts = []; }
  }
  // try backend /users if available
  try {
    const res = await fetch(BACKEND + '/users', { headers: token ? { 'Authorization': 'Bearer '+token } : {} });
    if(res.ok){
      const users = await res.json();
      // backend returns array of users. Filter self out.
      contacts = users.filter(u => u.email !== me.email).map(u => ({ name: u.username || u.email, email: u.email, id: u._id || u.id }));
      // persist
      localStorage.setItem('chatflow_contacts_'+(me.email||'guest'), JSON.stringify(contacts));
      renderContacts();
      return;
    }
  } catch(e){ /* ignore backend */ }
  // if no contacts yet, provide demo list
  if(!contacts || contacts.length === 0){
    contacts = [
      { name:'Alex', email:'alex@example.com' },
      { name:'Taylor', email:'taylor@example.com' },
      { name:'Jordan', email:'jordan@example.com' }
    ];
    localStorage.setItem('chatflow_contacts_'+(me.email||'guest'), JSON.stringify(contacts));
    renderContacts();
  }
}

// load messages from backend for this user (if available) and merge into chats
async function loadMessagesFromBackend(){
  if(!me || !me.id) return;
  try {
    const res = await fetch(BACKEND + '/messages/' + me.id, { headers: token ? { 'Authorization': 'Bearer '+token } : {} });
    if(!res.ok) return;
    const msgs = await res.json();
    // server message schema might vary. We'll try to normalize.
    msgs.forEach(m=>{
      // heuristics: try fields m.from, m.to, m.user, m.userId, m.message, m.text
      const text = m.message || m.text || m.msg || '';
      const fromEmail = m.fromEmail || m.from || (m.user ? (m.user.email || m.user) : me.email);
      const toEmail = m.toEmail || m.to || (m.userId && m.userId !== me.id ? me.email : null);
      // If unsure, push to a 'me' bucket
      const other = (fromEmail && fromEmail !== me.email) ? fromEmail : (toEmail && toEmail !== me.email ? toEmail : null);
      const key = other ? uid(me.email, other) : uid(me.email, 'me');
      if(!chats[key]) chats[key]=[];
      chats[key].push({ from: fromEmail || me.email, to: toEmail || null, text, ts: m.timestamp || m.createdAt || Date.now() });
    });
    saveChatsToStorage();
  } catch(e){
    // ignore - not fatal
    console.warn('No backend messages loaded', e);
  }
}

// send message: store locally, emit via socket, and optionally POST to backend
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text || !activeContact) return;
  const key = uid(me.email, activeContact.email);
  const msgObj = { from: me.email, to: activeContact.email, text, ts: Date.now() };

  if(!chats[key]) chats[key]=[];
  chats[key].push(msgObj);
  saveChatsToStorage();
  renderMessagesForActive();
  inputEl.value='';

  // emit via socket for realtime
  if(socket && socket.connected){
    socket.emit('send_message', { fromId: me.id, fromName: me.username, toEmail: activeContact.email, text });
  }

  // attempt to POST to backend messages endpoint if exists
  try {
    await fetch(BACKEND + '/messages', {
      method:'POST',
      headers: Object.assign({'Content-Type':'application/json'}, token ? { 'Authorization':'Bearer '+token } : {}),
      body: JSON.stringify({ from: me.email, to: activeContact.email, text })
    });
  } catch(e){ /* not required */ }
}

// socket receive handler
function onReceiveMessage(data){
  // expecting data: { fromId?, fromName?, from?, toEmail?, text?, user?, message? }
  const fromEmail = data.from || data.fromEmail || data.fromName || data.fromNameEmail || data.fromName;
  const text = data.text || data.message || data.msg;
  // fallback: if data.fromName and no email, use data.fromName
  const sender = data.from || data.fromEmail || data.fromName || (data.user?data.user: null);

  // determine target key
  const otherEmail = (sender && sender !== me.email) ? sender : (data.toEmail || data.to || null);
  if(!otherEmail) return;
  const key = uid(me.email, otherEmail);
  if(!chats[key]) chats[key]=[];
  chats[key].push({ from: sender || otherEmail, to: me.email, text: text || '', ts: Date.now() });
  saveChatsToStorage();

  // if active chat matches, render; otherwise show popup badge
  if(activeContact && (activeContact.email === otherEmail)){
    renderMessagesForActive();
  } else {
    showToast((sender || otherEmail) + ': ' + (text||''), 2500);
    // visually mark unread by adding a small indicator on contact (simple approach: prefix name with •)
    markContactUnread(otherEmail);
  }
}

// mark contact unread visually (simple)
function markContactUnread(email){
  // add a little bullet in contact's name
  const nodes = Array.from(document.querySelectorAll('.contact'));
  for(const n of nodes){
    const sub = n.querySelector('.sub');
    if(sub && sub.textContent === email){
      n.style.fontWeight = '700';
      break;
    }
  }
}

// remove unread mark when opened
function clearContactUnread(email){
  const nodes = Array.from(document.querySelectorAll('.contact'));
  for(const n of nodes){
    const sub = n.querySelector('.sub');
    if(sub && sub.textContent === email){
      n.style.fontWeight = '400';
      break;
    }
  }
}

// setup Socket.IO
function setupSocket(){
  try {
    socket = io(BACKEND, { auth: { token: token } });
    socket.on('connect', ()=>console.log('Socket connected', socket.id));
    socket.on('disconnect', ()=>console.log('Socket disconnected'));
    socket.on('receive_message', onReceiveMessage);
  } catch(e){
    console.warn('Socket failed', e);
  }
}

// load initial data then setup UI
async function init(){
  // try to load contacts from local storage or backend
  await loadContacts();

  // load messages from backend (if available)
  await loadMessagesFromBackend();

  // render contacts & UI
  renderContacts();
  showContactDetails(null);
  renderMessagesForActive();

  // setup socket
  setupSocket();

  // UI handlers
  document.getElementById('btnAddContact').addEventListener('click', openAddContactModal);
  document.getElementById('openSettings').addEventListener('click', openSettingsModal);
  document.getElementById('editProfile').addEventListener('click', openSettingsModal);
  document.getElementById('btnProfile').addEventListener('click', ()=>openProfileModal());
  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') sendMessage(); });
  searchInput.addEventListener('input', (e)=> renderContacts(e.target.value) );

  // if contacts exist, select first contact
  if(contacts.length) selectContact(contacts[0]);
}

// ---- Settings / profile modals (simple prompts for demo) ----
function openSettingsModal(){
  const newName = prompt('Change display name', me.username || '');
  if(newName){
    me.username = newName;
    localStorage.setItem('user', JSON.stringify(me));
    miniNameEl.textContent = me.username;
    profileNameEl.textContent = me.username;
    showToast('Name updated');
  }
}

function openProfileModal(){
  alert('Profile\n\nUsername: ' + (me.username||'') + '\nEmail: ' + (me.email||'') + '\n\nUse Settings to change display name.');
}

// start
init();

</script>

</body>
</html>
