<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Live Location - Like WhatsApp</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f0f8ff; 
        }
        h1 { color: #25D366; /* WhatsApp green */ }
        .duration-btn { 
            padding: 15px 20px; 
            margin: 10px; 
            font-size: 16px; 
            background-color: #25D366; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            min-width: 100px; 
        }
        .duration-btn:hover { background-color: #128C7E; }
        .duration-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #stopBtn { 
            background-color: #f44336; 
            margin-top: 20px; 
            display: none; 
        }
        #stopBtn:hover { background-color: #da190b; }
        #status { 
            margin: 20px; 
            font-weight: bold; 
            padding: 10px; 
            border-radius: 5px; 
            background-color: #e0f7fa; 
        }
        #timer { 
            font-size: 18px; 
            color: #25D366; 
            margin: 10px; 
        }
        #location { 
            margin: 20px; 
            padding: 10px; 
            background-color: white; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            display: none; 
        }
    </style>
</head>
<body>
    <h1>Share Live Location</h1>
    <p>Select duration and tap to share your location (like WhatsApp).</p>
    <button class="duration-btn" data-duration="900">15 Minutes</button>
    <button class="duration-btn" data-duration="3600">1 Hour</button>
    <button class="duration-btn" data-duration="28800">8 Hours</button>
    <button class="duration-btn" data-duration="0">Until Stopped</button>
    <button id="stopBtn">Stop Sharing</button>
    <div id="status">Status: Ready to share</div>
    <div id="timer"></div>
    <div id="location">Location: Not available</div>

    <script>
        // REPLACE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        auth.signInAnonymously().catch(console.error);

        let trackingInterval;
        let endTime = null;
        let isTracking = false;
        const userId = 'child1'; // CHANGE: e.g., 'child1', 'child2'
        const statusDiv = document.getElementById('status');
        const timerDiv = document.getElementById('timer');
        const locationDiv = document.getElementById('location');
        const stopBtn = document.getElementById('stopBtn');

        // Duration buttons
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const duration = parseInt(btn.dataset.duration);
                startSharing(duration);
                btn.disabled = true;
                document.querySelectorAll('.duration-btn').forEach(b => b.style.display = 'none');
                stopBtn.style.display = 'inline-block';
            });
        });

        stopBtn.addEventListener('click', stopSharing);

        function startSharing(durationSeconds) {
            if (!navigator.geolocation) {
                statusDiv.textContent = 'Geolocation not supported';
                return;
            }

            isTracking = true;
            endTime = durationSeconds > 0 ? Date.now() + (durationSeconds * 1000) : null;
            statusDiv.textContent = `Started sharing... Requesting location.`;
            statusDiv.style.backgroundColor = '#c8e6c9';

            navigator.geolocation.getCurrentPosition(onPositionSuccess, onPositionError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            });

            // Start timer countdown if duration set
            if (endTime) {
                updateTimer();
                setInterval(updateTimer, 1000);
            }
        }

        function onPositionSuccess(position) {
            if (!isTracking) return;
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const locationRef = db.ref('locations/' + userId);

            locationRef.set({
                lat: lat,
                lng: lng,
                timestamp: Date.now(),
                endTime: endTime,
                accuracy: position.coords.accuracy,
                userId: userId
            });

            locationDiv.innerHTML = `Sharing:<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>Accuracy: ${position.coords.accuracy.toFixed(0)}m`;
            locationDiv.style.display = 'block';
            statusDiv.textContent = endTime ? `Sharing live location until timer ends.` : 'Sharing live location...';

            // Periodic updates
            trackingInterval = setInterval(() => {
                if (!isTracking || (endTime && Date.now() > endTime)) {
                    stopSharing();
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        if (isTracking) {
                            locationRef.set({
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                timestamp: Date.now(),
                                endTime: endTime,
                                accuracy: pos.coords.accuracy,
                                userId: userId
                            });
                        }
                    },
                    onPositionError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
                );
            }, 30000); // 30s updates
        }

        function updateTimer() {
            if (!endTime || Date.now() > endTime) return;
            const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            timerDiv.textContent = `Time left: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            if (remaining <= 0) {
                stopSharing();
            }
        }

        function stopSharing() {
            isTracking = false;
            if (trackingInterval) clearInterval(trackingInterval);
            db.ref('locations/' + userId).remove();
            statusDiv.textContent = 'Sharing stopped.';
            statusDiv.style.backgroundColor = '#ffcdd2';
            timerDiv.textContent = '';
            locationDiv.style.display = 'none';
            stopBtn.style.display = 'none';
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.style.display = 'inline-block';
                btn.disabled = false;
            });
        }

        function onPositionError(error) {
            let msg = 'Error: ';
            switch (error.code) {
                case error.PERMISSION_DENIED: msg += 'Permission denied.'; break;
                case error.POSITION_UNAVAILABLE: msg += 'Location unavailable.'; break;
                case error.TIMEOUT: msg += 'Timeout.'; break;
            }
            statusDiv.textContent = msg;
            statusDiv.style.backgroundColor = '#ffcdd2';
            console.error(error);
        }

        window.addEventListener('beforeunload', stopSharing);
    </script>
</body>
</html>