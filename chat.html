<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatFlow â€” Chat</title>

<style>
  :root{
    --bg:#c7d2d7;
    --panel:#e5e6e4;
    --dark:#6c6b6b;
    --accent:#1f6feb;
    --muted:#dfd9c7;
  }

  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);display:flex;flex-direction:column;height:100vh;}

  header{padding:12px 16px;background:var(--panel);display:flex;align-items:center;gap:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
  header .avatar{width:44px;height:44px;border-radius:50%;background:var(--dark);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
  header .title{font-weight:700;font-size:16px;color:var(--dark);}
  header button{margin-left:auto;padding:6px 10px;border:none;background:var(--dark);color:white;border-radius:8px;cursor:pointer;font-size:12px;}

  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);}
  .msg{max-width:70%;padding:10px 14px;border-radius:12px;line-height:1.4;font-size:14px;}
  .msg.me{align-self:flex-end;background:var(--dark);color:white;border-bottom-right-radius:4px;}
  .msg.them{align-self:flex-start;background:var(--muted);color:var(--dark);border-bottom-left-radius:4px;}

  .compose{display:flex;padding:10px;background:var(--panel);gap:8px;align-items:center;}
  .compose input[type=text]{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.1);outline:none;}
  .compose button{padding:10px 14px;background:var(--dark);color:white;border:none;border-radius:12px;cursor:pointer;}

  .profile-pic-upload{display:flex;align-items:center;gap:8px;font-size:12px;margin-top:8px;}
  .profile-pic-upload input[type=file]{font-size:12px;}
</style>
</head>
<body>

<header>
  <div class="avatar" id="chatAvatar">C</div>
  <div class="title" id="chatName">Contact Name</div>
  <button id="btnBack">Back</button>
</header>

<div class="messages" id="messages">
  <div style="text-align:center;color:rgba(0,0,0,0.45)">No messages yet</div>
</div>

<div class="compose">
  <input type="text" id="inputMessage" placeholder="Write a message...">
  <button id="sendBtn">Send</button>
</div>

<div style="padding:10px;background:var(--panel)">
  <div class="profile-pic-upload">
    <label for="profilePic">Upload profile photo:</label>
    <input type="file" id="profilePic" accept="image/*">
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // ----- Setup -----
  const BACKEND = "https://chatflow-backend-574t.onrender.com";
  let socket = null;
  const me = JSON.parse(localStorage.getItem('user') || '{"email":"guest@local","username":"Guest"}');

  // select contact: for demo, choose first saved contact
  const contacts = JSON.parse(localStorage.getItem('chatflow_contacts_'+me.email)||'[]');
  const contact = contacts[0] || {name:'Alex', email:'alex@example.com'};
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('inputMessage');

  document.getElementById('chatName').textContent = contact.name;
  document.getElementById('chatAvatar').textContent = contact.name[0].toUpperCase();

  // ----- local storage chat key -----
  const key = [me.email, contact.email].sort().join('|');
  let chats = JSON.parse(localStorage.getItem('chatflow_chats_'+me.email)||'{}');
  if(!chats[key]) chats[key]=[];
  
  function renderMessages(){
    messagesEl.innerHTML = '';
    if(chats[key].length===0){
      messagesEl.innerHTML = '<div style="text-align:center;color:rgba(0,0,0,0.45)">No messages yet</div>';
      return;
    }
    chats[key].forEach(msg=>{
      const div = document.createElement('div');
      div.className = 'msg ' + (msg.from===me.email?'me':'them');
      div.textContent = msg.text;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function sendMessage(){
    const text = inputEl.value.trim();
    if(!text) return;
    const msgObj = {from: me.email, to: contact.email, text, ts: Date.now()};
    chats[key].push(msgObj);
    localStorage.setItem('chatflow_chats_'+me.email, JSON.stringify(chats));
    renderMessages();
    inputEl.value='';

    if(socket && socket.connected){
      socket.emit('send_message', {fromName: me.username, fromId: me.id, toEmail: contact.email, text});
    }
  }

  function onReceiveMessage(data){
    const from = data.fromEmail || data.from || contact.email;
    if(from!==contact.email) return;
    chats[key].push({from:from,to:me.email,text:data.text,ts:Date.now()});
    localStorage.setItem('chatflow_chats_'+me.email, JSON.stringify(chats));
    renderMessages();
  }

  // setup socket
  try {
    socket = io(BACKEND, { auth: { token: localStorage.getItem('token') } });
    socket.on('receive_message', onReceiveMessage);
  } catch(e){ console.warn('Socket failed', e); }

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  inputEl.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });
  document.getElementById('btnBack').addEventListener('click', ()=>{ location.href='dashboard.html'; });

  renderMessages();

  // ---- Profile photo upload ----
  const profilePicInput = document.getElementById('profilePic');
  profilePicInput.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      localStorage.setItem('profilePic_'+me.email, reader.result);
      document.getElementById('chatAvatar').style.backgroundImage = `url(${reader.result})`;
      document.getElementById('chatAvatar').textContent = '';
    };
    reader.readAsDataURL(file);
  });

  // load profile picture if exists
  const savedPic = localStorage.getItem('profilePic_'+me.email);
  if(savedPic){
    document.getElementById('chatAvatar').style.backgroundImage = `url(${savedPic})`;
    document.getElementById('chatAvatar').textContent = '';
  }

</script>
</body>
</html>
